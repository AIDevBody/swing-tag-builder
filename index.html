<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Swing Tag Builder</title>
  <style>
    :root { --gap: 12px; --pad: 14px; --radius: 12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; padding: 20px; background: #0b0f16; color: #eaf0ff; }
    a { color: #9bcbff; }
    header { margin-bottom: 22px; }
    .card { background: #121827; border: 1px solid #1f2a44; border-radius: var(--radius); padding: var(--pad); margin-bottom: var(--gap); }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: var(--gap); }
    .group { border: 1px solid #233455; border-radius: var(--radius); padding: var(--pad); }
    .group h3 { margin: 0 0 10px 0; font-size: 16px; font-weight: 600; color: #bcd1ff; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { border: 1px solid #2a3f66; padding: 6px 10px; border-radius: 999px; cursor: pointer; user-select: none; }
    .chip.active { background: #244f92; border-color: #3a6db8; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; }
    button, select { background: #1a2540; color: #eaf0ff; border: 1px solid #2a3f66; border-radius: 10px; padding: 8px 10px; }
    input[type="text"] { width: 100%; background: #0e1527; color: #eaf0ff; border: 1px solid #2a3f66; border-radius: 10px; padding: 10px; }
    .muted { color: #9fb3d9; }
    .footer { margin-top: 20px; font-size: 12px; }
    details { margin-top: 8px; }
    summary { cursor: pointer; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸŽ· Swing Tag Builder</h1>
    <p class="muted">Loads <code>/data/ui.csv</code> and <code>/data/tags.csv</code> (generated by the GitHub Action) and lets you compose tags. Choose a language to see display names.</p>
  </header>

  <section class="card">
    <div class="controls">
      <label>Language:&nbsp;
        <select id="lang"></select>
      </label>
      <button id="copyHashtags">Copy hashtags</button>
      <button id="clearAll">Clear all</button>
    </div>
    <details>
      <summary>Output</summary>
      <div style="margin-top:8px;">
        <input id="hashtags" type="text" readonly />
      </div>
    </details>
  </section>

  <section id="groups" class="row"></section>

  <div class="footer muted">
    <p>CSV sources are mirrored from Google Sheets by <code>scripts/fetch_tags.js</code> into <code>/data</code>. Refresh after a push to see updates.</p>
  </div>

  <script>
  // Minimal CSV parser that handles quotes and commas
  function parseCSV(text) {
    const rows = [];
    let cur = '', row = [], inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      if (c === '\"') {
        if (inQuotes && text[i+1] === '\"') { cur += '\"'; i++; }
        else inQuotes = !inQuotes;
      } else if (c === ',' && !inQuotes) {
        row.push(cur); cur = '';
      } else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (cur !== '' || row.length) { row.push(cur); rows.push(row); cur = ''; row = []; }
        // handle \r\n pair
        if (c === '\r' && text[i+1] === '\n') i++;
      } else {
        cur += c;
      }
    }
    if (cur !== '' || row.length) { row.push(cur); rows.push(row); }
    return rows;
  }

  async function fetchCSV(path) {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to load ' + path);
    const text = await res.text();
    return parseCSV(text);
  }

  function headersToIndex(headers) {
    const map = {};
    headers.forEach((h, i) => map[h.trim()] = i);
    return map;
  }

  function unique(arr) { return Array.from(new Set(arr)); }

  // Build UI based on ui.csv (tag_type -> ui_type) and tags.csv
  async function bootstrap() {
    try {
      const ui = await fetchCSV('data/ui.csv');
      const tags = await fetchCSV('data/tags.csv');

      if (ui.length === 0 || tags.length === 0) throw new Error('Empty CSV(s)');
      const uiIdx = headersToIndex(ui[0]);
      const tagsIdx = headersToIndex(tags[0]);

      // Detect languages
      const langHeaders = Object.keys(tagsIdx).filter(h => h.startsWith('display_'));
      const languages = langHeaders.map(h => h.replace('display_', ''));
      const langSel = document.getElementById('lang');
      languages.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l; opt.textContent = l;
        langSel.appendChild(opt);
      });
      // Default: navigator language if available
      const browserLang = (navigator.language || 'en').slice(0,2);
      if (languages.includes(browserLang)) langSel.value = browserLang; else if (languages.includes('en')) langSel.value = 'en';

      // Build map: tag_type -> ui_type
      const typeToUI = {};
      for (let i = 1; i < ui.length; i++) {
        const row = ui[i];
        if (!row.length) continue;
        const typ = row[uiIdx['tag_type']]?.trim();
        const uitype = row[uiIdx['ui_type']]?.trim();
        if (typ && uitype) typeToUI[typ] = uitype;
      }

      // Build tag groups by type
      const byType = {};
      for (let i = 1; i < tags.length; i++) {
        const row = tags[i];
        if (!row.length) continue;
        const typ = row[tagsIdx['tag_type']]?.trim();
        const tag = row[tagsIdx['tag']]?.trim();
        const activeIdx = tagsIdx['is-active'];
        const active = (activeIdx == null) ? true : (String(row[activeIdx]).toLowerCase() !== 'false');
        if (!typ || !tag || !active) continue;
        const ent = {
          tag,
          display: (lang) => {
            const h = 'display_' + lang;
            const idx = tagsIdx[h];
            return idx != null && row[idx] ? row[idx] : tag;
          }
        };
        (byType[typ] ||= []).push(ent);
      }

      const container = document.getElementById('groups');
      container.innerHTML = '';

      const state = {}; // {type: Set(tags)}

      function render() {
        // Build hashtags string
        const parts = [];
        Object.keys(state).forEach(typ => {
          state[typ].forEach(t => parts.push('#' + t));
        });
        const out = parts.join(' ');
        document.getElementById('hashtags').value = out;
      }

      function toggle(type, tag, on) {
        state[type] ||= new Set();
        if (on) state[type].add(tag);
        else state[type].delete(tag);
        render();
      }

      function renderGroup(type, items, uiType) {
        const lang = langSel.value;
        const card = document.createElement('div');
        card.className = 'group';
        const h = document.createElement('h3');
        h.textContent = type + ' (' + uiType + ')';
        card.appendChild(h);

        if (uiType === 'dropdown') {
          const sel = document.createElement('select');
          const emptyOpt = document.createElement('option');
          emptyOpt.textContent = 'â€”';
          emptyOpt.value = '';
          sel.appendChild(emptyOpt);
          items.forEach(it => {
            const opt = document.createElement('option');
            opt.value = it.tag; opt.textContent = it.display(lang);
            sel.appendChild(opt);
          });
          sel.addEventListener('change', () => {
            state[type] = new Set();
            if (sel.value) state[type].add(sel.value);
            render();
          });
          card.appendChild(sel);
        } else if (uiType === 'radio') {
          items.forEach((it, i) => {
            const id = `${type}-r-${i}`;
            const lab = document.createElement('label');
            lab.style.display = 'block';
            const input = document.createElement('input');
            input.type = 'radio'; input.name = 'r-' + type; input.id = id; input.value = it.tag;
            input.addEventListener('change', () => {
              state[type] = new Set([it.tag]); render();
            });
            lab.appendChild(input);
            const span = document.createElement('span'); span.textContent = ' ' + it.display(lang);
            lab.appendChild(span);
            card.appendChild(lab);
          });
        } else if (uiType === 'checkbox') {
          items.forEach((it, i) => {
            const id = `${type}-c-${i}`;
            const lab = document.createElement('label');
            lab.style.display = 'block';
            const input = document.createElement('input');
            input.type = 'checkbox'; input.id = id; input.value = it.tag;
            input.addEventListener('change', () => toggle(type, it.tag, input.checked));
            lab.appendChild(input);
            const span = document.createElement('span'); span.textContent = ' ' + it.display(lang);
            lab.appendChild(span);
            card.appendChild(lab);
          });
        } else if (uiType === 'multi') {
          const sel = document.createElement('select');
          sel.multiple = true;
          sel.size = Math.min(8, Math.max(3, items.length));
          items.forEach(it => {
            const opt = document.createElement('option');
            opt.value = it.tag; opt.textContent = it.display(lang);
            sel.appendChild(opt);
          });
          sel.addEventListener('change', () => {
            const chosen = new Set(Array.from(sel.selectedOptions).map(o => o.value));
            state[type] = chosen; render();
          });
          card.appendChild(sel);
        } else if (uiType === 'chips') {
          const wrap = document.createElement('div');
          wrap.className = 'chips';
          items.forEach(it => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.textContent = it.display(lang);
            chip.addEventListener('click', () => {
              const active = chip.classList.toggle('active');
              toggle(type, it.tag, active);
            });
            wrap.appendChild(chip);
          });
          card.appendChild(wrap);
        } else {
          const p = document.createElement('p');
          p.className = 'muted';
          p.textContent = `Unknown ui_type: ${uiType}`;
          card.appendChild(p);
        }

        container.appendChild(card);
      }

      Object.keys(byType).sort().forEach(type => {
        const uiType = typeToUI[type] || 'checkbox';
        renderGroup(type, byType[type], uiType);
      });

      langSel.addEventListener('change', () => {
        // re-render all groups with new language
        container.querySelectorAll('.group').forEach(g => g.remove());
        Object.keys(byType).sort().forEach(type => {
          const uiType = typeToUI[type] || 'checkbox';
          renderGroup(type, byType[type], uiType);
        });
        render();
      });

      document.getElementById('copyHashtags').addEventListener('click', async () => {
        const el = document.getElementById('hashtags');
        el.select(); el.setSelectionRange(0, 99999);
        try { await navigator.clipboard.writeText(el.value); } catch {}
      });
      document.getElementById('clearAll').addEventListener('click', () => {
        Object.keys(state).forEach(k => state[k].clear && state[k].clear());
        state.length = 0;
        // full rerender to reset inputs
        container.querySelectorAll('.group').forEach(g => g.remove());
        Object.keys(byType).sort().forEach(type => {
          const uiType = typeToUI[type] || 'checkbox';
          renderGroup(type, byType[type], uiType);
        });
        document.getElementById('hashtags').value = '';
      });

      render();
    } catch (e) {
      document.body.insertAdjacentHTML('beforeend', '<div class="card">Failed to load CSVs from <code>/data</code>. Push to the repo to let the Action fetch them, or place CSVs manually.</div>');
      console.error(e);
    }
  }

  bootstrap();
  </script>
</body>
</html>
